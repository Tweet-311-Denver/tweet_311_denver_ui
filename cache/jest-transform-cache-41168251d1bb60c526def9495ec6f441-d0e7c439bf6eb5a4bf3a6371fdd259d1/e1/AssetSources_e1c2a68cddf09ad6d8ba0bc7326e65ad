b34c01633fdff29659022f0bd7b9fd93
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.selectAssetSource = selectAssetSource;
exports.resolveUri = resolveUri;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _core = require("@unimodules/core");

var _pathBrowserify = _interopRequireDefault(require("path-browserify"));

var _reactNative = require("react-native");

var _urlParse = _interopRequireDefault(require("url-parse"));

var _AssetSourceResolver = _interopRequireDefault(require("./AssetSourceResolver"));

var _PlatformUtils = require("./PlatformUtils");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var assetMapOverride = (0, _PlatformUtils.getManifest)().assetMapOverride;

function selectAssetSource(meta) {
  if (assetMapOverride && assetMapOverride.hasOwnProperty(meta.hash)) {
    meta = _objectSpread({}, meta, {}, assetMapOverride[meta.hash]);
  }

  var scale = _AssetSourceResolver.default.pickScale(meta.scales, _reactNative.PixelRatio.get());

  var index = meta.scales.findIndex(function (s) {
    return s === scale;
  });
  var hash = meta.fileHashes ? meta.fileHashes[index] || meta.fileHashes[0] : meta.hash;
  var uri = meta.fileUris ? meta.fileUris[index] || meta.fileUris[0] : meta.uri;

  if (uri) {
    return {
      uri: resolveUri(uri),
      hash: hash
    };
  }

  var assetUrlOverride = (0, _PlatformUtils.getManifest)().assetUrlOverride;

  if (assetUrlOverride) {
    var _uri = _pathBrowserify.default.join(assetUrlOverride, hash);

    return {
      uri: resolveUri(_uri),
      hash: hash
    };
  }

  var fileScale = scale === 1 ? '' : "@" + scale + "x";
  var fileExtension = meta.type ? "." + encodeURIComponent(meta.type) : '';
  var suffix = "/" + encodeURIComponent(meta.name) + fileScale + fileExtension + "?platform=" + encodeURIComponent(_core.Platform.OS) + "&hash=" + encodeURIComponent(meta.hash);

  if (/^https?:\/\//.test(meta.httpServerLocation)) {
    var _uri2 = meta.httpServerLocation + suffix;

    return {
      uri: _uri2,
      hash: hash
    };
  }

  if ((0, _PlatformUtils.getManifest)().developer) {
    var baseUrl = new _urlParse.default((0, _PlatformUtils.getManifest)().bundleUrl);
    baseUrl.set('pathname', meta.httpServerLocation + suffix);
    return {
      uri: baseUrl.href,
      hash: hash
    };
  }

  return {
    uri: "https://d1wp6m56sqw74a.cloudfront.net/~assets/" + encodeURIComponent(hash),
    hash: hash
  };
}

function resolveUri(uri) {
  if (!_PlatformUtils.manifestBaseUrl) {
    return uri;
  }

  var _ref = new _urlParse.default(uri),
      protocol = _ref.protocol;

  if (protocol !== '') {
    return uri;
  }

  var baseUrl = new _urlParse.default(_PlatformUtils.manifestBaseUrl);
  var resolvedPath = uri.startsWith('/') ? uri : _pathBrowserify.default.join(baseUrl.pathname, uri);
  baseUrl.set('pathname', resolvedPath);
  return baseUrl.href;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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ckIsS0FBUDtBQUNEOztBQUdELFNBQU87QUFDTCxJQUFBLEdBQUcscURBQW1ELGtCQUFrQixDQUFDLElBQUQsQ0FEbkU7QUFFTCxJQUFBLElBQUksRUFBSjtBQUZLLEdBQVA7QUFJRDs7QUFPSyxTQUFVLFVBQVYsQ0FBcUIsR0FBckIsRUFBZ0M7QUFDcEMsTUFBSSxDQUFDLDhCQUFMLEVBQXNCO0FBQ3BCLFdBQU8sR0FBUDtBQUNEOztBQUhtQyxhQUtmLElBQUksaUJBQUosQ0FBUSxHQUFSLENBTGU7QUFBQSxNQUs1QixRQUw0QixRQUs1QixRQUw0Qjs7QUFNcEMsTUFBSSxRQUFRLEtBQUssRUFBakIsRUFBcUI7QUFDbkIsV0FBTyxHQUFQO0FBQ0Q7O0FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxpQkFBSixDQUFRLDhCQUFSLENBQWhCO0FBQ0EsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLFVBQUosQ0FBZSxHQUFmLElBQXNCLEdBQXRCLEdBQTRCLHdCQUFLLElBQUwsQ0FBVSxPQUFPLENBQUMsUUFBbEIsRUFBNEIsR0FBNUIsQ0FBakQ7QUFDQSxFQUFBLE9BQU8sQ0FBQyxHQUFSLENBQVksVUFBWixFQUF3QixZQUF4QjtBQUNBLFNBQU8sT0FBTyxDQUFDLElBQWY7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAnQHVuaW1vZHVsZXMvY29yZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoLWJyb3dzZXJpZnknO1xuaW1wb3J0IHsgUGl4ZWxSYXRpbyB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5pbXBvcnQgVVJMIGZyb20gJ3VybC1wYXJzZSc7XG5pbXBvcnQgQXNzZXRTb3VyY2VSZXNvbHZlciBmcm9tICcuL0Fzc2V0U291cmNlUmVzb2x2ZXInO1xuXG5pbXBvcnQgeyBtYW5pZmVzdEJhc2VVcmwsIGdldE1hbmlmZXN0IH0gZnJvbSAnLi9QbGF0Zm9ybVV0aWxzJztcblxuZXhwb3J0IHR5cGUgQXNzZXRNZXRhZGF0YSA9IHtcbiAgaGFzaDogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIHR5cGU6IHN0cmluZztcbiAgd2lkdGg/OiBudW1iZXI7XG4gIGhlaWdodD86IG51bWJlcjtcbiAgc2NhbGVzOiBudW1iZXJbXTtcbiAgaHR0cFNlcnZlckxvY2F0aW9uOiBzdHJpbmc7XG4gIHVyaT86IHN0cmluZztcbiAgZmlsZUhhc2hlcz86IHN0cmluZ1tdO1xuICBmaWxlVXJpcz86IHN0cmluZ1tdO1xufTtcblxuZXhwb3J0IHR5cGUgQXNzZXRTb3VyY2UgPSB7XG4gIHVyaTogc3RyaW5nO1xuICBoYXNoOiBzdHJpbmc7XG59O1xuXG4vLyBGYXN0IGxvb2t1cCBjaGVjayBpZiBhc3NldCBtYXAgaGFzIGFueSBvdmVycmlkZXMgaW4gdGhlIG1hbmlmZXN0XG5jb25zdCBhc3NldE1hcE92ZXJyaWRlID0gZ2V0TWFuaWZlc3QoKS5hc3NldE1hcE92ZXJyaWRlO1xuXG4vKipcbiAqIFNlbGVjdHMgdGhlIGJlc3QgZmlsZSBmb3IgdGhlIGdpdmVuIGFzc2V0IChleDogY2hvb3NpbmcgdGhlIGJlc3Qgc2NhbGUgZm9yIGltYWdlcykgYW5kIHJldHVybnNcbiAqIGEgeyB1cmksIGhhc2ggfSBwYWlyIGZvciB0aGUgc3BlY2lmaWMgYXNzZXQgZmlsZS5cbiAqXG4gKiBJZiB0aGUgYXNzZXQgaXNuJ3QgYW4gaW1hZ2Ugd2l0aCBtdWx0aXBsZSBzY2FsZXMsIHRoZSBmaXJzdCBmaWxlIGlzIHNlbGVjdGVkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0QXNzZXRTb3VyY2UobWV0YTogQXNzZXRNZXRhZGF0YSk6IEFzc2V0U291cmNlIHtcbiAgLy8gT3ZlcnJpZGUgd2l0aCB0aGUgYXNzZXQgbWFwIGluIG1hbmlmZXN0IGlmIGF2YWlsYWJsZVxuICBpZiAoYXNzZXRNYXBPdmVycmlkZSAmJiBhc3NldE1hcE92ZXJyaWRlLmhhc093blByb3BlcnR5KG1ldGEuaGFzaCkpIHtcbiAgICBtZXRhID0geyAuLi5tZXRhLCAuLi5hc3NldE1hcE92ZXJyaWRlW21ldGEuaGFzaF0gfTtcbiAgfVxuXG4gIC8vIFRoaXMgbG9naWMgaXMgYmFzZWQgb24gdGhhdCBvZiBBc3NldFNvdXJjZVJlc29sdmVyLCB3aXRoIGFkZGl0aW9uYWwgc3VwcG9ydCBmb3IgZmlsZSBoYXNoZXMgYW5kXG4gIC8vIGV4cGxpY2l0bHkgcHJvdmlkZWQgVVJJc1xuICBjb25zdCBzY2FsZSA9IEFzc2V0U291cmNlUmVzb2x2ZXIucGlja1NjYWxlKG1ldGEuc2NhbGVzLCBQaXhlbFJhdGlvLmdldCgpKTtcbiAgY29uc3QgaW5kZXggPSBtZXRhLnNjYWxlcy5maW5kSW5kZXgocyA9PiBzID09PSBzY2FsZSk7XG4gIGNvbnN0IGhhc2ggPSBtZXRhLmZpbGVIYXNoZXMgPyBtZXRhLmZpbGVIYXNoZXNbaW5kZXhdIHx8IG1ldGEuZmlsZUhhc2hlc1swXSA6IG1ldGEuaGFzaDtcblxuICAvLyBBbGxvdyBhc3NldCBwcm9jZXNzb3JzIHRvIGRpcmVjdGx5IHByb3ZpZGUgdGhlIFVSTCB0byBsb2FkXG4gIGNvbnN0IHVyaSA9IG1ldGEuZmlsZVVyaXMgPyBtZXRhLmZpbGVVcmlzW2luZGV4XSB8fCBtZXRhLmZpbGVVcmlzWzBdIDogbWV0YS51cmk7XG4gIGlmICh1cmkpIHtcbiAgICByZXR1cm4geyB1cmk6IHJlc29sdmVVcmkodXJpKSwgaGFzaCB9O1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgdGhlIGFzc2V0VXJsIHdhcyBvdmVycmlkZGVuIGluIHRoZSBtYW5pZmVzdFxuICBjb25zdCBhc3NldFVybE92ZXJyaWRlID0gZ2V0TWFuaWZlc3QoKS5hc3NldFVybE92ZXJyaWRlO1xuICBpZiAoYXNzZXRVcmxPdmVycmlkZSkge1xuICAgIGNvbnN0IHVyaSA9IHBhdGguam9pbihhc3NldFVybE92ZXJyaWRlLCBoYXNoKTtcbiAgICByZXR1cm4geyB1cmk6IHJlc29sdmVVcmkodXJpKSwgaGFzaCB9O1xuICB9XG5cbiAgY29uc3QgZmlsZVNjYWxlID0gc2NhbGUgPT09IDEgPyAnJyA6IGBAJHtzY2FsZX14YDtcbiAgY29uc3QgZmlsZUV4dGVuc2lvbiA9IG1ldGEudHlwZSA/IGAuJHtlbmNvZGVVUklDb21wb25lbnQobWV0YS50eXBlKX1gIDogJyc7XG4gIGNvbnN0IHN1ZmZpeCA9IGAvJHtlbmNvZGVVUklDb21wb25lbnQoXG4gICAgbWV0YS5uYW1lXG4gICl9JHtmaWxlU2NhbGV9JHtmaWxlRXh0ZW5zaW9ufT9wbGF0Zm9ybT0ke2VuY29kZVVSSUNvbXBvbmVudChcbiAgICBQbGF0Zm9ybS5PU1xuICApfSZoYXNoPSR7ZW5jb2RlVVJJQ29tcG9uZW50KG1ldGEuaGFzaCl9YDtcblxuICAvLyBGb3IgYXNzZXRzIHdpdGggYSBzcGVjaWZpZWQgYWJzb2x1dGUgVVJMLCB3ZSB1c2UgdGhlIGV4aXN0aW5nIG9yaWdpbiBpbnN0ZWFkIG9mIHByZXBlbmRpbmcgdGhlXG4gIC8vIGRldmVsb3BtZW50IHNlcnZlciBvciBwcm9kdWN0aW9uIENETiBVUkwgb3JpZ2luXG4gIGlmICgvXmh0dHBzPzpcXC9cXC8vLnRlc3QobWV0YS5odHRwU2VydmVyTG9jYXRpb24pKSB7XG4gICAgY29uc3QgdXJpID0gbWV0YS5odHRwU2VydmVyTG9jYXRpb24gKyBzdWZmaXg7XG4gICAgcmV0dXJuIHsgdXJpLCBoYXNoIH07XG4gIH1cblxuICAvLyBGb3IgYXNzZXRzIGR1cmluZyBkZXZlbG9wbWVudCwgd2UgdXNlIHRoZSBkZXZlbG9wbWVudCBzZXJ2ZXIncyBVUkwgb3JpZ2luXG4gIGlmIChnZXRNYW5pZmVzdCgpLmRldmVsb3Blcikge1xuICAgIGNvbnN0IGJhc2VVcmwgPSBuZXcgVVJMKGdldE1hbmlmZXN0KCkuYnVuZGxlVXJsKTtcbiAgICBiYXNlVXJsLnNldCgncGF0aG5hbWUnLCBtZXRhLmh0dHBTZXJ2ZXJMb2NhdGlvbiArIHN1ZmZpeCk7XG4gICAgcmV0dXJuIHsgdXJpOiBiYXNlVXJsLmhyZWYsIGhhc2ggfTtcbiAgfVxuXG4gIC8vIFByb2R1Y3Rpb24gQ0ROIFVSSXMgYXJlIGJhc2VkIG9uIGVhY2ggYXNzZXQgZmlsZSBoYXNoXG4gIHJldHVybiB7XG4gICAgdXJpOiBgaHR0cHM6Ly9kMXdwNm01NnNxdzc0YS5jbG91ZGZyb250Lm5ldC9+YXNzZXRzLyR7ZW5jb2RlVVJJQ29tcG9uZW50KGhhc2gpfWAsXG4gICAgaGFzaCxcbiAgfTtcbn1cblxuLyoqXG4gKiBSZXNvbHZlcyB0aGUgZ2l2ZW4gVVJJIHRvIGFuIGFic29sdXRlIFVSSS4gSWYgdGhlIGdpdmVuIFVSSSBpcyBhbHJlYWR5IGFuIGFic29sdXRlIFVSSSwgaXQgaXNcbiAqIHNpbXBseSByZXR1cm5lZC4gT3RoZXJ3aXNlLCBpZiBpdCBpcyBhIHJlbGF0aXZlIFVSSSwgaXQgaXMgcmVzb2x2ZWQgcmVsYXRpdmUgdG8gdGhlIG1hbmlmZXN0J3NcbiAqIGJhc2UgVVJJLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVVyaSh1cmk6IHN0cmluZyk6IHN0cmluZyB7XG4gIGlmICghbWFuaWZlc3RCYXNlVXJsKSB7XG4gICAgcmV0dXJuIHVyaTtcbiAgfVxuXG4gIGNvbnN0IHsgcHJvdG9jb2wgfSA9IG5ldyBVUkwodXJpKTtcbiAgaWYgKHByb3RvY29sICE9PSAnJykge1xuICAgIHJldHVybiB1cmk7XG4gIH1cblxuICBjb25zdCBiYXNlVXJsID0gbmV3IFVSTChtYW5pZmVzdEJhc2VVcmwpO1xuICBjb25zdCByZXNvbHZlZFBhdGggPSB1cmkuc3RhcnRzV2l0aCgnLycpID8gdXJpIDogcGF0aC5qb2luKGJhc2VVcmwucGF0aG5hbWUsIHVyaSk7XG4gIGJhc2VVcmwuc2V0KCdwYXRobmFtZScsIHJlc29sdmVkUGF0aCk7XG4gIHJldHVybiBiYXNlVXJsLmhyZWY7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9